<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Developer Verification — UPGACC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;padding:24px;background:#f6f7fb;color:#111}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    #status{color:#666;font-size:14px}
    #cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:18px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06);padding:16px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .meta{color:#666;font-size:13px;margin-bottom:10px}
    .buttons{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600;transition:background 0.2s}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .danger{background:#fee2e2;color:#991b1b}
    .danger:hover:not(:disabled){background:#fecaca}
    .success{background:#d1fae5;color:#065f46}
    .success:hover:not(:disabled){background:#a7f3d0}
    .info{background:#eff6ff;color:#1d4ed8}
    .info:hover:not(:disabled){background:#dbeafe}
    .status-pending{color:#f59e0b; font-weight:700;}
    .status-verified{color:#059669; font-weight:700;}
  </style>
</head>
<body>
  <header>
    <h1>Developer Verification Dashboard</h1>
    <div id="status" class="text-sm">Memeriksa status otentikasi...</div>
  </header>
  
  <div id="loader" class="text-gray-500">Memuat data pendaftaran...</div>
  <div id="cards">
    <!-- Data pendaftaran akan dimuat di sini -->
  </div>

  <div id="errorMsg" class="hidden mt-4 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, updateDoc, deleteDoc, collection, query, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// --- GLOBAL VARIABLES (MANDATORY FOR CANVAS ENVIRONMENT) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  // Ganti dengan konfigurasi Anda jika Anda tidak menggunakan Canvas
  apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
  authDomain: "forumwidara.firebaseapp.com",
  projectId: "forumwidara",
  storageBucket: "forumwidara.appspot.com",
  appId: "1:216895655168:web:59255f600fc3b3b44eb7e5",
};
setLogLevel('debug'); // Wajib untuk debugging firestore
// --- END GLOBAL VARIABLES ---

// --- CONFIG KHUSUS ---
// Developer UID yang diizinkan sesuai security rules:
const DEVELOPER_UID = "W9ombzh6y0Mj1AAJEFxL53H1YAR2";
// Path koleksi yang dipantau (harus sama dengan rules)
const VERIFICATION_COLLECTION_PATH = `artifacts/${appId}/public/data/sekolah`;
// --- END CONFIG KHUSUS ---

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusEl = document.getElementById('status');
const loaderEl = document.getElementById('loader');
const cardsEl = document.getElementById('cards');
const errorMsgEl = document.getElementById('errorMsg');

let isAuthReady = false;
let currentUserId = null;

function showError(message, error = null) {
    console.error(message, error);
    errorMsgEl.classList.remove('hidden');
    errorMsgEl.innerHTML = `<strong>ERROR:</strong> ${message} ${error ? `<br/>(${error.code || error.message})` : ''}`;
}

// 1. Inisialisasi Auth Listener
onAuthStateChanged(auth, (user) => {
    isAuthReady = true;
    loaderEl.classList.add('hidden');
    
    if (user && user.uid === DEVELOPER_UID) {
        currentUserId = user.uid;
        statusEl.innerHTML = `<span class="text-green-600 font-bold">Authenticated as Developer: ${DEVELOPER_UID}</span>`;
        // Panggil fungsi untuk mengambil data HANYA JIKA ini adalah Developer UID
        fetchVerificationData();
    } else {
        // Tampilkan pesan error jika bukan developer atau tidak login
        statusEl.innerHTML = `<span class="text-red-600 font-bold">Unauthorized. UID required: ${DEVELOPER_UID}</span>`;
        showError('Akses Ditolak. Anda harus login sebagai Developer UID yang disyaratkan.', { message: 'Unauthorized Access' });
        
        // Tampilkan prompt login jika belum login
        if(!user) displayLoginPrompt();
    }
});

// 2. Fungsi Login Developer Manual (Jika diperlukan)
async function developerLogin(email, password) {
    try {
        await setPersistence(auth, browserSessionPersistence);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        if (userCredential.user.uid === DEVELOPER_UID) {
            alert('Login Berhasil. Dashboard akan di refresh.'); // Menggunakan alert karena ini adalah skenario developer/debug
            window.location.reload();
        } else {
            // Log out user yang salah
            await auth.signOut();
            showError('Login Berhasil, tetapi UID tidak cocok dengan Developer UID yang disyaratkan.');
        }
    } catch(err) {
        showError('Gagal Login Developer.', err);
    }
}

function displayLoginPrompt() {
    // Implementasi UI prompt sederhana untuk login developer
    const loginDiv = document.createElement('div');
    loginDiv.className = 'mt-4 p-4 bg-yellow-100 border border-yellow-400 rounded-lg max-w-sm';
    loginDiv.innerHTML = `
        <h4 class="font-bold text-yellow-800">Login Developer</h4>
        <p class="text-xs text-gray-700 mb-2">Login sebagai ${DEVELOPER_UID} untuk melanjutkan.</p>
        <input id="devEmail" type="email" placeholder="Email Developer" class="w-full p-2 border rounded-lg mb-2 text-sm">
        <input id="devPass" type="password" placeholder="Password Developer" class="w-full p-2 border rounded-lg mb-4 text-sm">
        <button id="devLoginBtn" class="w-full bg-yellow-600 text-white p-2 rounded-lg font-semibold hover:bg-yellow-700">Login</button>
    `;
    document.body.appendChild(loginDiv);

    document.getElementById('devLoginBtn').addEventListener('click', () => {
        const email = document.getElementById('devEmail').value;
        const password = document.getElementById('devPass').value;
        document.getElementById('devLoginBtn').textContent = 'Loading...';
        developerLogin(email, password);
    });
}


// 3. Fungsi Pengambilan Data
function fetchVerificationData() {
    const q = query(collection(db, VERIFICATION_COLLECTION_PATH));

    // Gunakan onSnapshot untuk real-time update
    onSnapshot(q, (snapshot) => {
        cardsEl.innerHTML = ''; // Kosongkan tampilan
        
        if (snapshot.empty) {
            cardsEl.innerHTML = `<div class="text-gray-500 col-span-full">Tidak ada pendaftaran baru yang perlu diverifikasi.</div>`;
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            const docId = doc.id;
            
            // Render Card
            const card = createCard(docId, data);
            cardsEl.appendChild(card);
        });
    }, (error) => {
        showError('Gagal mengambil data dari Firestore. Cek Security Rules dan koneksi Anda.', error);
    });
}

// 4. Fungsi Pembuatan Kartu
function createCard(docId, data) {
    const statusClass = data.status_verifikasi === 'terverifikasi' ? 'status-verified' : 'status-pending';
    const card = document.createElement('div');
    card.className = 'card';
    card.id = `card-${docId}`;
    card.innerHTML = `
        <h3 class="text-blue-700">${escapeHtml(data.nama_sekolah)}</h3>
        <p class="meta">Admin UID: ${escapeHtml(data.original_uid)}</p>
        <p class="meta">Dokumen ID: ${escapeHtml(docId)}</p>
        <p class="mb-3">Status: <span class="${statusClass}">${escapeHtml(data.status_verifikasi || 'pending')}</span></p>
        
        <p><strong>Kepala:</strong> ${escapeHtml(data.nama_kepala)}</p>
        <p><strong>Email:</strong> ${escapeHtml(data.email_admin)}</p>
        <p><strong>Kode Sekolah:</strong> ${escapeHtml(data.kode_sekolah)}</p>
        <p class="text-xs text-gray-500 mt-2">Daftar: ${data.created_at ? new Date(data.created_at.seconds * 1000).toLocaleString() : 'N/A'}</p>

        <div class="buttons mt-4">
            <button class="info view-raw-btn">Lihat Raw</button>
            <button class="success approve-btn" ${data.status_verifikasi === 'terverifikasi' ? 'disabled' : ''}>Verifikasi & Approve</button>
            <button class="danger delete-btn">Hapus/Tolak</button>
        </div>
    `;

    const approveBtn = card.querySelector('.approve-btn');
    const deleteBtn = card.querySelector('.delete-btn');
    const viewRawBtn = card.querySelector('.view-raw-btn');

    // Menampilkan Raw Data
    const rawPre = document.createElement('pre');
    rawPre.className = 'text-xs p-2 bg-gray-50 mt-2 rounded-lg overflow-auto';
    rawPre.textContent = JSON.stringify(data, null, 2);
    let rawVisible = false;
    viewRawBtn.addEventListener('click', () => {
        if (!rawVisible) { card.appendChild(rawPre); rawVisible = true; viewRawBtn.textContent = 'Sembunyikan Raw'; }
        else { rawPre.remove(); rawVisible = false; viewRawBtn.textContent = 'Lihat Raw'; }
    });

    // Aksi Verifikasi
    approveBtn.addEventListener('click', async () => {
        if (!confirm('Yakin ingin menandai pendaftaran ini sebagai TERVERIFIKASI?')) return;
        
        try {
            const verifDocRef = doc(db, VERIFICATION_COLLECTION_PATH, docId);
            const masterDocRef = doc(db, 'sekolah', data.original_uid);

            // 1. Update status di koleksi verifikasi
            await updateDoc(verifDocRef, { status_verifikasi: 'terverifikasi', verified_by: currentUserId, verified_at: serverTimestamp() });
            
            // 2. Update status di koleksi master (opsional, untuk cross-reference)
            // Rules: allow update: if request.auth != null && (request.auth.uid == userId || request.auth.uid == DEVELOPER_UID)
            await updateDoc(masterDocRef, { status_verifikasi: 'terverifikasi', verified_by_dev: currentUserId, updated_at: serverTimestamp() });

            approveBtn.textContent = '✔️ Terverifikasi';
            approveBtn.disabled = true;
            card.querySelector(`.${statusClass}`).textContent = 'terverifikasi';
            card.querySelector(`.${statusClass}`).className = 'status-verified';
            
        } catch (err) {
            showError('Gagal mengubah status verifikasi. Periksa permissions (rules) atau apakah dokumen master sudah terhapus.', err);
        }
    });

    // Aksi Hapus/Tolak
    deleteBtn.addEventListener('click', async () => {
        if (!confirm('Yakin ingin MENGHAPUS dokumen pendaftaran ini? Tindakan ini permanen.')) return;
        try {
            const docRef = doc(db, VERIFICATION_COLLECTION_PATH, docId);
            await deleteDoc(docRef);
            // Kartu akan otomatis hilang karena onSnapshot
        } catch (err) {
            showError('Gagal menghapus dokumen. Periksa permissions (rules).', err);
        }
    });

    return card;
}

function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[c])); }
</script>
</body>
</html>

