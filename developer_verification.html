<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Developer Verification — UPGACC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;padding:24px;background:#f6f7fb;color:#111}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    #status{color:#666;font-size:14px}
    #cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:18px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06);padding:16px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .meta{color:#666;font-size:13px;margin-bottom:10px}
    .buttons{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600;transition:background 0.2s}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .danger{background:#fee2e2;color:#991b1b}
    .danger:hover:not(:disabled){background:#fecaca}
    .success{background:#d1fae5;color:#065f46}
    .success:hover:not(:disabled){background:#a7f3d0}
    .info{background:#eff6ff;color:#1d4ed8}
    .info:hover:not(:disabled){background:#dbeafe}
    .status-pending{color:#f59e0b; font-weight:700;}
    .status-verified{color:#059669; font-weight:700;}

    /* Modal Styling */
    #devLoginModal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;display:flex;align-items:center;justify-content:center;}
    
    /* Document Preview Modal */
    #docPreviewModal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85); z-index: 200; display: none;
      align-items: center; justify-content: center;
    }
    #docPreviewContent {
      position: relative; max-width: 90%; max-height: 90%; 
      background: white; padding: 10px; border-radius: 8px;
    }
    #docPreviewClose {
      position: absolute; top: -10px; right: -10px; 
      background: white; border-radius: 50%; padding: 5px 10px; 
      font-size: 16px; font-weight: bold; cursor: pointer;
    }
    #docPreviewViewer {
      max-width: 100%; max-height: 80vh; 
      object-fit: contain; /* Agar gambar tidak terpotong */
    }
  </style>
</head>
<body>
  <header>
    <h1>Developer Verification Dashboard</h1>
    <div id="status" class="text-sm">Memeriksa status otentikasi...</div>
  </header>
  
  <div id="loader" class="text-gray-500">Memuat data pendaftaran...</div>
  <div id="cards">
    <!-- Data pendaftaran akan dimuat di sini -->
  </div>

  <div id="errorMsg" class="hidden mt-4 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg"></div>

  <!-- Developer Login Modal -->
  <div id="devLoginModal" class="hidden">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
      <h3 class="text-xl font-bold mb-4 text-red-700">Akses Dibatasi</h3>
      <div id="devLoginMsg" class="text-sm text-gray-700 mb-3">Anda harus login sebagai Developer UID yang disyaratkan: **W9ombzh6y0Mj1AAJEFxL53H1YAR2**</div>
      <label class="block mb-3">Email
        <input id="devEmail" type="email" placeholder="Email Developer" class="rounded-lg">
      </label>
      <label class="block mb-4">Password
        <input id="devPass" type="password" placeholder="Password Developer" class="rounded-lg">
      </label>
      <button id="devLoginBtn" class="w-full bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-700">Login Developer</button>
    </div>
  </div>

  <!-- Document Preview Modal -->
  <div id="docPreviewModal" style="display: none;">
    <div id="docPreviewContent">
      <span id="docPreviewClose">X</span>
      <div id="docPreviewViewer" class="bg-gray-100 p-2 rounded-lg"></div>
    </div>
  </div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, setPersistence, browserSessionPersistence, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, updateDoc, deleteDoc, collection, query, onSnapshot, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// --- GLOBAL VARIABLES (MANDATORY FOR CANVAS ENVIRONMENT) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  // Config dummy jika tidak di Canvas
  apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
  authDomain: "forumwidara.firebaseapp.com",
  projectId: "forumwidara",
  storageBucket: "forumwidara.appspot.com",
  appId: "1:216899999999:web:59255f600fc3b3b44eb7e5",
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
setLogLevel('debug'); // Wajib untuk debugging firestore
// --- END GLOBAL VARIABLES ---

// --- CONFIG KHUSUS ---
const DEVELOPER_UID = "W9ombzh6y0Mj1AAJEFxL53H1YAR2";
const VERIFICATION_COLLECTION_PATH = `artifacts/${appId}/public/data/sekolah`;
// --- END CONFIG KHUSUS ---

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusEl = document.getElementById('status');
const loaderEl = document.getElementById('loader');
const cardsEl = document.getElementById('cards');
const errorMsgEl = document.getElementById('errorMsg');
const devLoginModal = document.getElementById('devLoginModal');
const devLoginBtn = document.getElementById('devLoginBtn');
const devLoginMsg = document.getElementById('devLoginMsg');
const docPreviewModal = document.getElementById('docPreviewModal');
const docPreviewViewer = document.getElementById('docPreviewViewer');
const docPreviewClose = document.getElementById('docPreviewClose');

let currentUserId = null;

function showError(message, error = null) {
    console.error(message, error);
    errorMsgEl.classList.remove('hidden');
    errorMsgEl.innerHTML = `<strong>ERROR:</strong> ${message} ${error ? `<br/>(${error.code || error.message})` : ''}`;
}

// 0. Inisialisasi Auth Awal
async function initializeAuth() {
  if (initialAuthToken) {
    try {
      // Masuk menggunakan custom token Canvas
      await signInWithCustomToken(auth, initialAuthToken);
    } catch(e) {
      console.error('Initial token sign-in failed:', e);
    }
  }
}
initializeAuth();


// 1. Auth Listener Utama
onAuthStateChanged(auth, (user) => {
    loaderEl.classList.add('hidden');
    
    if (user && user.uid === DEVELOPER_UID) {
        currentUserId = user.uid;
        statusEl.innerHTML = `<span class="text-green-600 font-bold">Authenticated as Developer: ${DEVELOPER_UID}</span>`;
        devLoginModal.classList.add('hidden');
        fetchVerificationData();
    } else {
        // Tampilkan prompt login jika bukan developer
        currentUserId = user ? user.uid : null;
        statusEl.innerHTML = `<span class="text-red-600 font-bold">Unauthorized. Current UID: ${user ? user.uid : 'N/A'}</span>`;
        displayLoginPrompt();
    }
});

// 2. Fungsi Login Developer Manual
devLoginBtn.addEventListener('click', async () => {
    const email = document.getElementById('devEmail').value;
    const password = document.getElementById('devPass').value;
    if(!email || !password) { devLoginMsg.textContent = 'Email dan password wajib diisi.'; return; }
    
    devLoginMsg.textContent = 'Mencoba login...';
    devLoginBtn.disabled = true;

    try {
        await setPersistence(auth, browserSessionPersistence);
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        
        if (userCredential.user.uid === DEVELOPER_UID) {
            // onAuthStateChanged akan menangani UI setelah login berhasil
            devLoginMsg.textContent = 'Login Berhasil. Memuat Dashboard...';
        } else {
            await auth.signOut();
            devLoginMsg.innerHTML = `<span class="text-red-700">Gagal: UID tidak cocok.</span>`;
        }
    } catch(err) {
        console.error(err);
        devLoginMsg.innerHTML = `<span class="text-red-700">Gagal Login: ${err.message || err.code}</span>`;
    } finally {
        devLoginBtn.disabled = false;
    }
});


function displayLoginPrompt() {
    devLoginModal.style.display = 'flex';
}

// Menutup modal preview
docPreviewClose.addEventListener('click', () => {
    docPreviewModal.style.display = 'none';
    docPreviewViewer.innerHTML = '';
});

// Fungsi untuk menampilkan dokumen/gambar di modal
function showDocumentPreview(url, title) {
    docPreviewViewer.innerHTML = '';
    docPreviewModal.style.display = 'flex';

    let content;
    const isPdf = url.includes('.pdf') || url.includes('/pdf/');
    
    // Perbaikan: gunakan transformasi Cloudinary untuk optimasi bandwidth saat menampilkan gambar
    const optimizedUrl = url.replace('/upload/', '/upload/q_auto,f_auto,w_800/');

    if (isPdf) {
        // Gunakan iframe untuk PDF
        content = `<iframe src="${optimizedUrl}" class="w-full h-full" style="width: 80vw; height: 80vh; border: none;"></iframe>`;
    } else {
        // Gunakan tag img untuk gambar dengan batas ukuran
        content = `<img src="${optimizedUrl}" alt="${title}" id="docPreviewImage" style="max-width: 80vw; max-height: 80vh;" class="object-contain mx-auto">`;
    }

    docPreviewViewer.innerHTML = content;
}


// 3. Fungsi Pengambilan Data
function fetchVerificationData() {
    // Karena data yang diambil adalah dokumen kecil dari Firestore (hanya link), 
    // IndexedDB tidak diperlukan untuk optimasi bandwidth pada data ini.
    // Fokus pada onSnapshot untuk real-time.
    const q = query(collection(db, VERIFICATION_COLLECTION_PATH));

    onSnapshot(q, (snapshot) => {
        cardsEl.innerHTML = ''; // Kosongkan tampilan
        
        if (snapshot.empty) {
            cardsEl.innerHTML = `<div class="text-gray-500 col-span-full">Tidak ada pendaftaran baru yang perlu diverifikasi.</div>`;
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            const docId = doc.id;
            
            // Render Card
            const card = createCard(docId, data);
            cardsEl.appendChild(card);
        });
    }, (error) => {
        showError('Gagal mengambil data dari Firestore. Cek Security Rules dan koneksi Anda.', error);
    });
}

// 4. Fungsi Pembuatan Kartu
function createCard(docId, data) {
    const statusText = data.status_verifikasi === 'terverifikasi' ? 'terverifikasi' : 'pending';
    const statusClass = data.status_verifikasi === 'terverifikasi' ? 'status-verified' : 'status-pending';
    
    const card = document.createElement('div');
    card.className = 'card';
    card.id = `card-${docId}`;
    card.innerHTML = `
        <h3 class="text-blue-700">${escapeHtml(data.nama_sekolah)}</h3>
        <p class="meta">Admin UID: ${escapeHtml(data.original_uid)}</p>
        <p class="meta">Dokumen ID: ${escapeHtml(docId)}</p>
        <p class="mb-3">Status: <span class="${statusClass}">${escapeHtml(statusText)}</span></p>
        
        <p><strong>Kepala:</strong> ${escapeHtml(data.nama_kepala)}</p>
        <p><strong>Email:</strong> ${escapeHtml(data.email_admin)}</p>
        <p><strong>Kode Sekolah:</strong> ${escapeHtml(data.kode_sekolah)}</p>
        <p class="text-xs text-gray-500 mt-2">Daftar: ${data.created_at ? new Date(data.created_at.seconds * 1000).toLocaleString() : 'N/A'}</p>

        <div class="flex flex-wrap gap-2 mt-4 text-sm">
            <button data-url="${escapeHtml(data.url_sk_pengangkatan)}" data-title="SK Pengangkatan" class="preview-doc-btn info">Preview SK</button>
            <button data-url="${escapeHtml(data.url_bukti_pendirian)}" data-title="Bukti Pendirian" class="preview-doc-btn info">Preview Bukti</button>
        </div>

        <div class="buttons mt-4 pt-4 border-t border-gray-100">
            <button class="success approve-btn" ${statusText === 'terverifikasi' ? 'disabled' : ''}>Verifikasi & Approve</button>
            <button class="danger delete-btn">Hapus/Tolak</button>
        </div>
    `;

    const approveBtn = card.querySelector('.approve-btn');
    const deleteBtn = card.querySelector('.delete-btn');
    
    // 5. Listener untuk Preview Dokumen
    card.querySelectorAll('.preview-doc-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const url = e.target.getAttribute('data-url');
            const title = e.target.getAttribute('data-title');
            if (url) {
                showDocumentPreview(url, title);
            }
        });
    });

    // Aksi Verifikasi
    approveBtn.addEventListener('click', async () => {
        if (!confirm('Yakin ingin menandai pendaftaran ini sebagai TERVERIFIKASI?')) return;
        
        try {
            const verifDocRef = doc(db, VERIFICATION_COLLECTION_PATH, docId);
            const masterDocRef = doc(db, 'sekolah', data.original_uid);

            // 1. Update status di koleksi verifikasi
            await updateDoc(verifDocRef, { status_verifikasi: 'terverifikasi', verified_by: currentUserId, verified_at: serverTimestamp() });
            
            // 2. Update status di koleksi master (Wajib dilakukan Developer UID)
            await updateDoc(masterDocRef, { status_verifikasi: 'terverifikasi', verified_by_dev: currentUserId, updated_at: serverTimestamp() });

            approveBtn.textContent = '✔️ Terverifikasi';
            approveBtn.disabled = true;
            card.querySelector(`.${statusClass}`).textContent = 'terverifikasi';
            card.querySelector(`.${statusClass}`).className = 'status-verified';
            
        } catch (err) {
            showError('Gagal mengubah status verifikasi. Periksa permissions (rules) atau apakah dokumen master sudah terhapus.', err);
        }
    });

    // Aksi Hapus/Tolak
    deleteBtn.addEventListener('click', async () => {
        if (!confirm('Yakin ingin MENGHAPUS dokumen pendaftaran ini? Tindakan ini permanen.')) return;
        try {
            const docRef = doc(db, VERIFICATION_COLLECTION_PATH, docId);
            await deleteDoc(docRef);
            // Kartu akan otomatis hilang karena onSnapshot
        } catch (err) {
            showError('Gagal menghapus dokumen. Periksa permissions (rules).', err);
        }
    });

    return card;
}

function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[c])); }
</script>
</body>
</html>

