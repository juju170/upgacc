<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Program Sekolah</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item:hover { background-color: #3b82f6; }
        /* Style untuk mobile sidebar agar bisa digeser keluar */
        .sidebar {
            /* Pastikan sidebar tersembunyi di mobile secara default */
            transform: translateX(-100%);
            position: fixed;
            z-index: 40; /* Di atas konten lain, di bawah overlay */
            height: 100vh;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        /* Style untuk overlay mobile */
        .sidebar-overlay {
            z-index: 30;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.open {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Overlay Loading (dipertahankan dari file asli) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm text-gray-600 mt-3">Memuat data...</p>
        </div>
    </div>

    <!-- Container Utama - Menggunakan sistem sidebar dinamis -->
    <div class="flex h-screen bg-gray-100">
        
        <!-- Overlay untuk Mobile Sidebar (Sesuai sistem di main_admin.txt) -->
        <div id="sidebar-overlay" class="sidebar-overlay hidden fixed inset-0 bg-black bg-opacity-50 transition-opacity md:hidden"></div>

        <!-- Placeholder untuk Sidebar (Akan diisi oleh JavaScript) -->
        <!-- Ini adalah pengganti untuk sidebar yang dulunya hardcoded di sini -->
        <div id="sidebar-container"></div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            
            <!-- Header/Navbar (Dipertahankan dari file asli) -->
            <header class="flex items-center justify-between p-4 bg-white border-b border-gray-200 sticky top-0 z-10">
                <div class="flex items-center">
                    <!-- Tombol Hamburger untuk Mobile (Penting untuk sistem sidebar) -->
                    <button id="sidebar-toggle-btn" class="text-gray-500 hover:text-gray-700 md:hidden mr-4">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>
                    <h1 class="text-2xl font-semibold text-gray-800">Dashboard Admin</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-display" class="text-sm font-medium text-gray-600">Loading User...</span>
                    <button id="logout-btn" class="text-red-500 hover:text-red-700 transition duration-150">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12" />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="p-6">
                <!-- Status & Welcome Section -->
                <section class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Selamat Datang, Admin!</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card 1: Total Pengguna -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                            <p class="text-sm font-medium text-gray-500">Total Pengguna Aktif</p>
                            <p class="text-3xl font-extrabold text-indigo-600 mt-1">1,245</p>
                            <span class="text-xs text-green-500 mt-2 block">+12% Bulan Ini</span>
                        </div>
                        <!-- Card 2: Kelas Aktif -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                            <p class="text-sm font-medium text-gray-500">Kelas Program Aktif</p>
                            <p class="text-3xl font-extrabold text-green-600 mt-1">15</p>
                            <span class="text-xs text-yellow-500 mt-2 block">2 Kelas Baru Menunggu</span>
                        </div>
                        <!-- Card 3: Pesan Baru -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                            <p class="text-sm font-medium text-gray-500">Pesan/Masukan Baru</p>
                            <p class="text-3xl font-extrabold text-red-600 mt-1">4</p>
                            <span class="text-xs text-blue-500 mt-2 block">Perlu Ditindaklanjuti</span>
                        </div>
                    </div>
                </section>

                <!-- API Key Section (Dipertahankan dari file asli) -->
                <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Kunci API Rahasia</h3>
                    <p class="text-gray-600 mb-3">Gunakan kunci ini untuk otentikasi layanan eksternal. Jaga kerahasiaannya!</p>
                    <div class="flex flex-col md:flex-row items-start md:items-center space-y-3 md:space-y-0 md:space-x-4">
                        <code id="secret-key-display" class="bg-gray-100 text-sm p-3 rounded-lg flex-1 font-mono break-all">
                            xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx
                        </code>
                        <button id="copy-key-button-dash" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition duration-150">
                            <svg class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75M17.25 17.25H12c-.621 0-1.125-.504-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125h5.25c.621 0 1.125.504 1.125 1.125v9.375c0 .621-.504 1.125-1.125 1.125z" />
                            </svg>
                            Salin Kode
                        </button>
                    </div>
                    <p id="copy-status-dash" class="text-xs mt-2 text-green-600"></p>
                </section>
                
            </main>
        </div>
    </div>
    
    <!-- Script untuk Firebase dan Logika Halaman -->
    <script type="module">
        // Import Firebase (Mengikuti sistem yang diharapkan ada)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables (Penting untuk lingkungan Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug'); // Aktifkan logging debug
        } catch (e) {
            console.error("Gagal menginisialisasi Firebase:", e);
        }

        // --- Konten HTML Sidebar (Diambil dari sidebar_template.html) ---
        const SIDEBAR_HTML_CONTENT = `
            <aside id="sidebar" class="sidebar flex flex-col w-64 bg-indigo-900 text-white transition-all duration-300 md:translate-x-0">
                <div class="flex items-center justify-center h-16 bg-indigo-950">
                    <svg class="h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.906 59.906 0 0112 3.493a59.906 59.906 0 0110.375 2.844c-.832.502-1.649.92-2.458 1.31M12 20.904l9.26-4.996m-18.52 0l9.26 4.996" />
                    </svg>
                    <span class="text-xl font-bold ml-3 text-indigo-100">Admin Panel</span>
                </div>
                <nav class="flex-1 px-2 py-4 space-y-2 overflow-y-auto">
                    <p class="px-4 pt-4 pb-2 text-xs font-semibold text-indigo-400 uppercase tracking-wider">Navigasi Utama</p>
                    <a href="./dashboard_admin.html" class="flex items-center px-4 py-2 text-white bg-indigo-700 rounded-md">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h7.5A2.25 2.25 0 0113.5 5.25v2.25M3.75 3h-2.25M13.5 7.5h3.75A2.25 2.25 0 0119.5 9.75v3.75c0 .604-.158 1.177-.432 1.684l-1.077 1.615.41.979c.67.994 1.137 2.152 1.137 3.376 0 .621-.504 1.125-1.125 1.125H4.125A2.25 2.25 0 012 19.125V4.875A2.25 2.25 0 014.125 2.625h12.125a2.25 2.25 0 012.25 2.25z" />
                        </svg>
                        <span class="ml-3">Dashboard</span>
                    </a>
                    <p class="px-4 pt-4 pb-2 text-xs font-semibold text-indigo-400 uppercase tracking-wider">Kelola Data</p>
                    <a href="./data_siswa.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a4.5 4.5 0 002.343-3.375m0 0H15M4.297 17.5l.593-.593.582.582.592.592.583-.583.592-.592.583.583 2.072-2.072M16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM12 18.75a4.5 4.5 0 004.5-4.5v-2.25m-4.5 2.25h-2.25" />
                        </svg>
                        <span class="ml-3">Data Siswa</span>
                    </a>
                    <a href="./data_guru.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0v2.25H4.5v-2.25z" />
                        </svg>
                        <span class="ml-3">Data Guru</span>
                    </a>
                    <a href="./data_kelas.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.5M8.25 3v4.5M16.5 21v-4.5M16.5 3v4.5M3.75 12h17.5" />
                        </svg>
                        <span class="ml-3">Data Kelas</span>
                    </a>
                    <p class="px-4 pt-4 pb-2 text-xs font-semibold text-indigo-400 uppercase tracking-wider">Kelola Konten</p>
                    <a href="./data_program.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                       <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6-2.292m0-14.25v14.25" />
                       </svg>
                       <span class="ml-3">Data Program</span>
                    </a>
                </nav>
            </aside>
        `;

        // --- Logika Sidebar dan Halaman (Mengikuti main_admin.txt) ---

        /**
         * Memuat sidebar secara dinamis ke dalam container.
         * Ini mensimulasikan fetch di main_admin.txt dengan menggunakan string hardcoded.
         */
        function loadSidebar() {
            const sidebarContainer = document.getElementById('sidebar-container');
            if (!sidebarContainer) return;

            // Masukkan konten sidebar ke dalam container
            sidebarContainer.innerHTML = SIDEBAR_HTML_CONTENT;
            
            // Panggil fungsi inisialisasi setelah sidebar berhasil dimuat
            initializeSidebarEvents();
        }

        /**
         * Menginisialisasi event listener untuk sidebar (mobile toggle).
         */
        function initializeSidebarEvents() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (!sidebar || !toggleBtn || !overlay) return;

            // Fungsi untuk membuka/menutup sidebar
            const toggleSidebar = () => {
                const isHidden = !sidebar.classList.toggle('open');
                overlay.classList.toggle('open', !isHidden);
                overlay.classList.toggle('hidden', isHidden);
            };

            // Event listener
            toggleBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
        }

        /**
         * Menginisialisasi otentikasi, tampilan user, dan logika spesifik dashboard.
         */
        // Ganti fungsi initializeDashboardLogic() yang ada
async function initializeDashboardLogic() {
    
    // Pastikan variabel-variabel ada sebelum digunakan
    const userDisplay = document.getElementById('user-display');
    const loadingOverlay = document.getElementById('loading-overlay');
    const initialAuthToken = new URLSearchParams(window.location.search).get('auth');

    try {
        if (auth) {
            
            // 1. Coba Otentikasi
            if (initialAuthToken) {
                // Mencoba sign-in dengan token dari URL
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                // Jika tidak ada token, coba sign-in Anonymous (sesuai logika asli Anda)
                await signInAnonymously(auth);
            }

            // Listener untuk memperbarui UI saat status berubah
            // (Listener ini tetap penting untuk otentikasi berkelanjutan, tapi BUKAN untuk menghilangkan loading awal)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const userId = user.uid;
                    userDisplay.textContent = `User ID: ${userId.substring(0, 8)}...`;
                } else {
                    userDisplay.textContent = 'Guest/Signed Out';
                    // Opsional: Redirect ke login jika sudah sign-out
                    // window.location.href = '../login.html';
                }
            });

            // 2. Logika Logout dan Copy Key
            // Dipindahkan ke dalam try agar hanya diinisialisasi jika Auth objek tersedia
            
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    console.log('Logout berhasil.');
                    window.location.href = '../login.html';
                }).catch((error) => {
                    console.error('Logout gagal:', error);
                });
            });

            const copyBtnDash = document.getElementById('copy-key-button-dash');
            // ... (Kode Copy Key yang sudah ada di file Anda) ...
            if (copyBtnDash) {
                const copyStatusDash = document.getElementById('copy-status-dash');
                copyBtnDash.addEventListener('click', () => {
                    const secretKey = document.getElementById('secret-key-display').textContent;
                    
                    navigator.clipboard.writeText(secretKey)
                        .then(() => {
                            copyStatusDash.textContent = 'Kode berhasil disalin!';
                            setTimeout(() => { copyStatusDash.textContent = '' }, 2000);
                        })
                        .catch(err => {
                            console.error("Gagal menyalin menggunakan Clipboard API:", err);
                            copyStatusDash.textContent = 'Gagal menyalin. Salin manual!';
                            setTimeout(() => { copyStatusDash.textContent = '' }, 3000);
                        });
                });
            }

        } else {
            userDisplay.textContent = 'Firebase Auth Error';
        }
        
    } catch (e) {
         // Blok ini menangkap error inisialisasi otentikasi (misal: token tidak valid)
         console.error("Kesalahan saat inisialisasi otentikasi:", e);
         userDisplay.textContent = 'Error Auth';
         
    } finally {
        // *** BAGIAN PENTING: Selalu sembunyikan overlay setelah TRY atau CATCH selesai ***
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
    }
}        
        console.error("Kesalahan saat inisialisasi otentikasi:", e);
                 document.getElementById('user-display').textContent = 'Error Auth';
            }
        }

        // Event listener utama (Sesuai sistem di main_admin.txt)
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Memuat sidebar (Fungsi yang disinkronkan)
            loadSidebar();

            // 2. Menginisialisasi fungsionalitas spesifik dashboard
            initializeDashboardLogic();
        });

    </script>
</body>
</html>

