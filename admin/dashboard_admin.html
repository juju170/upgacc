<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Program Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item:hover { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Overlay Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-xl text-gray-700 mt-3">Memuat data dashboard...</p>
        </div>
    </div>
    
    <div id="app-content" class="hidden flex h-screen bg-gray-100">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white flex flex-col p-4 shadow-xl">
            <div class="text-2xl font-bold text-blue-400 mb-8">Admin Sekolah</div>
            <nav class="flex-1 space-y-2">
                <a href="#" class="sidebar-item block p-3 rounded-lg bg-blue-600 transition duration-150">
                    Dashboard Utama
                </a>
                <a href="#" class="sidebar-item block p-3 rounded-lg hover:bg-gray-700 transition duration-150">
                    Manajemen Guru
                </a>
                <a href="#" class="sidebar-item block p-3 rounded-lg hover:bg-gray-700 transition duration-150">
                    Pengaturan
                </a>
            </nav>
            <button id="logout-button" class="mt-8 p-3 bg-red-600 rounded-lg font-semibold hover:bg-red-700 transition duration-150">
                Logout
            </button>
        </div>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <header class="h-16 bg-white shadow-md flex items-center justify-between px-6 sticky top-0 z-10">
                <div class="text-xl font-semibold text-gray-800">Selamat Datang, <span id="admin-name">Admin</span>!</div>
            </header>

            <main class="p-6">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Dashboard Admin</h1>
                
                <!-- Section: Informasi Sekolah -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-600">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Informasi Sekolah</h2>
                        
                        <p class="text-sm text-gray-500 mb-2">Nama Sekolah:</p>
                        <p id="school-name-display" class="text-xl font-bold text-blue-600 mb-4">Memuat...</p>
                        
                        <!-- Elemen untuk menampilkan UID/Kode Unik -->
                        <p class="text-sm text-gray-500 mb-2">Kode Unik Admin (UID Sekolah):</p>
                        <p id="school-id-display" class="text-lg font-mono bg-gray-50 text-gray-700 p-2 rounded-lg break-all mb-4">Memuat...</p>
                        
                        <p class="text-sm text-gray-500 mb-2 mt-4">Kunci Rahasia Aplikasi (API Key):</p>
                        <div class="flex items-center space-x-2">
                            <span id="secret-key-display" class="text-lg font-mono bg-yellow-50 text-yellow-800 p-2 rounded-lg rounded-r-none select-none">Memuat...</span>
                            <button id="copy-key-button-dash" class="text-sm font-medium bg-blue-100 text-blue-700 p-2 rounded-lg rounded-l-none hover:bg-blue-200 transition duration-150">
                                Salin
                            </button>
                        </div>
                        <p id="copy-status-dash" class="text-xs text-green-600 mt-1"></p>
                    </div>

                    <!-- Card Statistik -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-600">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Statistik Cepat</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b pb-2">
                                <span class="text-gray-600">Total Guru Terdaftar:</span>
                                <span id="total-guru" class="text-2xl font-bold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between items-center border-b pb-2">
                                <span class="text-gray-600">Status Verifikasi:</span>
                                <span id="verification-status" class="text-base font-bold text-green-500">Terverifikasi</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="p-4 text-center text-sm text-gray-500 border-t mt-auto">
                &copy; 2024 UPGACC. All rights reserved.
            </footer>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // setLogLevel('debug'); // Aktifkan log untuk debugging permissions
        
        // --- GLOBAL VARIABLES (MANDATORY FOR CANVAS ENVIRONMENT) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Dummy config for local testing
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            appId: "1:216899999999:web:59255f600fc3b3b44eb7e5",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END GLOBAL VARIABLES ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContent = document.getElementById('app-content');
        const schoolIdDisplay = document.getElementById('school-id-display'); 

        // Inisialisasi Auth
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Initial token sign-in failed:", e));
        }

        // Listener Auth Utama
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const schoolId = user.uid;
                loadAdminData(schoolId);
            } else {
                // Pengguna tidak login atau sesi berakhir, arahkan ke login
                window.location.href = '../login.html'; 
            }
        });

        // Fungsi Pengambilan Data Admin
        async function loadAdminData(schoolId) {
            try {
                // 1. Ambil data sekolah (koleksi master 'sekolah' menggunakan UID)
                const sekolahDocRef = doc(db, 'sekolah', schoolId);
                const docSnap = await getDoc(sekolahDocRef);

                if (!docSnap.exists() || docSnap.data().status_verifikasi !== 'terverifikasi') {
                    // Cek keamanan ganda: Jika dokumen tidak ada atau belum terverifikasi, paksa logout.
                    await signOut(auth);
                    // Gunakan modal/pesan kustom jika alert() tidak diizinkan, tapi untuk error fatal ini, alert() adalah yang tercepat.
                    alert("Akses ditolak: Akun belum terverifikasi atau data sekolah hilang. Mengarahkan kembali ke login.");
                    window.location.href = '../login.html';
                    return;
                }
                
                const adminData = docSnap.data();
                
                // 2. TAMPILKAN UID ADMIN
                schoolIdDisplay.textContent = schoolId;
                
                // 3. Tampilkan data lainnya
                document.getElementById('admin-name').textContent = adminData.nama_kepala || 'Admin Sekolah';
                document.getElementById('school-name-display').textContent = adminData.nama_sekolah;
                document.getElementById('secret-key-display').textContent = adminData.kode_kunci_rahasia;

                // 4. Hitung jumlah guru (menggunakan 'id_sekolah' yang sama dengan schoolId)
                const guruQuery = query(collection(db, "guru"), where("id_sekolah", "==", schoolId));
                const guruSnapshot = await getDocs(guruQuery);
                document.getElementById('total-guru').textContent = guruSnapshot.size;

                // Sembunyikan loading, tampilkan konten
                loadingOverlay.classList.add('hidden');
                appContent.classList.remove('hidden');

            } catch(error) {
                console.error("Gagal memuat data Admin:", error);
                
                let errorMsg = "Gagal memuat data dashboard.";
                
                // FIX Permissions: Memberi panduan spesifik jika ada error permission-denied
                if (error.code === 'permission-denied') {
                    errorMsg = "Akses Ditolak (Firestore): Akun Anda telah terverifikasi, tetapi terjadi error 'missing or insufficient permissions'. \n\nMohon periksa FIREBASE SECURITY RULES Anda. Aturan Anda harus mengizinkan pengguna yang sudah login (request.auth != null) untuk membaca koleksi 'sekolah' (hanya dokumen mereka) dan melakukan query pada koleksi 'guru'.";
                } else {
                    errorMsg += " Error: " + error.message;
                }
                
                // Tampilkan pesan error dan paksa logout
                alert(errorMsg);
                await signOut(auth);
                window.location.href = '../login.html';
            }
        }
        
        // Fungsi Logout
        const logoutButton = document.getElementById('logout-button');
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log('Logout berhasil.');
                // Arahkan ke login.html (dari folder admin, kembali satu tingkat)
                window.location.href = '../login.html';
            }).catch((error) => {
                console.error('Logout gagal:', error);
            });
        });
        
        // Fungsi Salin Kode (API Key)
        const copyBtnDash = document.getElementById('copy-key-button-dash');
        const copyStatusDash = document.getElementById('copy-status-dash');
        copyBtnDash.addEventListener('click', () => {
            const secretKey = document.getElementById('secret-key-display').textContent;
            
            // FIX ERROR 'appendChild': Menggunakan API Clipboard modern saja (menghapus fallback yang tidak stabil)
            navigator.clipboard.writeText(secretKey)
                .then(() => {
                    copyStatusDash.textContent = 'Kode berhasil disalin!';
                    setTimeout(() => { copyStatusDash.textContent = '' }, 2000);
                })
                .catch(err => {
                    // Jika Clipboard API gagal (misalnya, browser tidak mendukung), tampilkan pesan
                    console.error("Gagal menyalin menggunakan Clipboard API:", err);
                    copyStatusDash.textContent = 'Gagal menyalin. Salin manual!';
                    setTimeout(() => { copyStatusDash.textContent = '' }, 3000);
                });
        });

    </script>
</body>
</html>

