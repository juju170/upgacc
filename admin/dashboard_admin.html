<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Program Sekolah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-item:hover { background-color: #3b82f6; }
        /* Styling untuk sidebar dari template user */
        .bg-indigo-900 { background-color: #3f3e79; }
        .bg-indigo-950 { background-color: #2b2b5a; }
        .text-indigo-400 { color: #8183d3; }
        .hover\:bg-indigo-700:hover { background-color: #5d5c9c; }
        /* Overlay untuk mobile saat sidebar terbuka */
        .sidebar-overlay { background: rgba(0, 0, 0, 0.5); z-index: 30; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Overlay Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-xl text-gray-700 mt-3">Memuat data dashboard...</p>
        </div>
    </div>
    
    <div id="app-content" class="hidden flex h-screen bg-gray-100">

        <!-- Overlay Sidebar (Mobile) -->
        <div id="sidebar-backdrop" class="fixed inset-0 sidebar-overlay hidden md:hidden transition-opacity duration-300" aria-hidden="true"></div>

        <!-- Sidebar (Menggunakan konten dari sidebar_template.html) -->
        <!-- FIX: Menggunakan transform dan transition untuk efek slide-in/out -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-300 ease-in-out z-40 w-64 bg-indigo-900 text-white flex-col p-0 shadow-2xl md:flex md:shadow-xl">
            <div class="flex items-center justify-between h-16 bg-indigo-950 px-4">
                <div class="flex items-center">
                    <svg class="h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.906 59.906 0 0112 3.493a59.906 59.906 0 0117.846 1.841c-.694.263-1.378.526-2.062.788M12 4.502a48.55 48.55 0 00-8.232 4.41 50.57 50.57 0 00-2.658.813M12 10.904a48.55 48.55 0 008.232 4.41 50.57 50.57 0 002.658-.813m-15.482-4.41a50.57 50.57 0 00-2.658-.813" />
                    </svg>
                    <span class="text-xl font-bold ml-2">UPGACC Admin</span>
                </div>
                <!-- Tombol close untuk mobile -->
                <button id="sidebar-close" class="md:hidden text-indigo-400 hover:text-white focus:outline-none p-2">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="#" class="flex items-center px-4 py-2 text-indigo-200 bg-indigo-700 rounded-md">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15A2.25 2.25 0 016 12.75h2.25A2.25 2.25 0 0110.5 15v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V15zM12.75 6A2.25 2.25 0 0115 3.75h2.25A2.25 2.25 0 0119.5 6v2.25a2.25 2.25 0 01-2.25 2.25H15a2.25 2.25 0 01-2.25-2.25V6zM12.75 15A2.25 2.25 0 0115 12.75h2.25A2.25 2.25 0 0119.5 15v2.25a2.25 2.25 0 01-2.25 2.25H15a2.25 2.25 0 01-2.25-2.25V15z" />
                    </svg>
                    <span class="ml-3">Dashboard</span>
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-indigo-400 uppercase tracking-wider">Data Sekolah</p>
                <a href="./data_guru.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.668.675 1.5 1.5 0 001.442-1.895l-1.571-3.649a1.5 1.5 0 00-.765-.892 7.749 7.749 0 01-3.697-.681m-2.126-.856A3.5 3.5 0 1114 6.75a3.5 3.5 0 01-1.126 1.488M12 21.75c-5.523 0-10-4.477-10-10S6.477 1.75 12 1.75s10 4.477 10 10-4.477 10-10 10zM12 14.25a7.49 7.49 0 00-7.49 7.49m7.49-7.49c3.087 0 5.864 1.25 7.49 3.25" />
                    </svg>
                    <span class="ml-3">Data Guru</span>
                </a>
                <a href="./data_siswa.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.964 0a1.5 1.5 0 00-1.203-2.183 10.973 10.973 0 00-11.566 0 1.5 1.5 0 00-1.203 2.183m11.964 0c-.015.088-.029.175-.045.263M12 13.9a3.25 3.25 0 100-6.5 3.25 3.25 0 000 6.5z" />
                    </svg>
                    <span class="ml-3">Data Siswa</span>
                </a>
                <a href="./data_kelas.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5a1.5 1.5 0 011.5 1.5v3.75a1.5 1.5 0 01-1.5 1.5H12m1.5-7.5h-3m3 3h-3m3 3h-3m4.5-10.5h-9A1.5 1.5 0 003 4.5v15A1.5 1.5 0 004.5 21h15a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5h-9z" />
                    </svg>
                    <span class="ml-3">Data Kelas</span>
                </a>

                <p class="px-4 pt-4 pb-2 text-xs font-semibold text-indigo-400 uppercase tracking-wider">Kelola Konten</p>
                <a href="./data_program.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                   <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292M12 6.042V20.904" />
                   </svg>
                   <span class="ml-3">Data Program</span>
               </a>
               <a href="./data_materi.html" class="flex items-center px-4 py-2 text-indigo-200 hover:bg-indigo-700 rounded-md">
                   <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.25c0-1.036-.84-1.875-1.875-1.875h-8.25a1.875 1.875 0 00-1.875 1.875v2.25m11.25 0a1.875 1.875 0 01-1.875 1.875H6.75a1.875 1.875 0 01-1.875-1.875m11.25 0L15 8.25m4.5 6L18 8.25m-11.25 6L6 8.25" />
                   </svg>
                   <span class="ml-3">Data Materi</span>
               </a>
            </nav>
            
            <div class="p-4 border-t border-indigo-800">
                <button id="logout-button" class="w-full p-3 bg-red-600 rounded-lg font-semibold hover:bg-red-700 transition duration-150">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main content -->
        <div class="flex flex-col flex-1 overflow-y-auto">
            <header class="h-16 bg-white shadow-md flex items-center justify-between px-6 sticky top-0 z-10">
                <!-- FIX: Tombol Toggle Sidebar (Hanya tampil di mobile) -->
                <button id="sidebar-toggle" class="md:hidden text-gray-600 hover:text-gray-900 focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path id="open-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
                
                <div class="text-xl font-semibold text-gray-800 flex-1 ml-4 md:ml-0">Selamat Datang, <span id="admin-name">Admin</span>!</div>
            </header>

            <main class="p-6">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Dashboard Admin</h1>
                
                <!-- Section: Informasi Sekolah -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-600">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Informasi Sekolah</h2>
                        
                        <p class="text-sm text-gray-500 mb-2">Nama Sekolah:</p>
                        <p id="school-name-display" class="text-xl font-bold text-blue-600 mb-4">Memuat...</p>
                        
                        <p class="text-sm text-gray-500 mb-2">Kode Unik Admin (UID Sekolah):</p>
                        <p id="school-id-display" class="text-lg font-mono bg-gray-50 text-gray-700 p-2 rounded-lg break-all mb-4">Memuat...</p>
                        
                        <p class="text-sm text-gray-500 mb-2 mt-4">Kunci Rahasia Aplikasi (API Key):</p>
                        <div class="flex items-center space-x-2">
                            <span id="secret-key-display" class="text-lg font-mono bg-yellow-50 text-yellow-800 p-2 rounded-lg rounded-r-none select-none">Memuat...</span>
                            <button id="copy-key-button-dash" class="text-sm font-medium bg-blue-100 text-blue-700 p-2 rounded-lg rounded-l-none hover:bg-blue-200 transition duration-150">
                                Salin
                            </button>
                        </div>
                        <p id="copy-status-dash" class="text-xs text-green-600 mt-1"></p>
                    </div>

                    <!-- Card Statistik -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-600">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Statistik Cepat</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b pb-2">
                                <span class="text-gray-600">Total Guru Terdaftar:</span>
                                <span id="total-guru" class="text-2xl font-bold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between items-center border-b pb-2">
                                <span class="text-gray-600">Status Verifikasi:</span>
                                <span id="verification-status" class="text-base font-bold text-green-500">Terverifikasi</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="p-4 text-center text-sm text-gray-500 border-t mt-auto">
                &copy; 2024 UPGACC. All rights reserved.
            </footer>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // setLogLevel('debug'); // Aktifkan log untuk debugging permissions
        
        // --- GLOBAL VARIABLES (MANDATORY FOR CANVAS ENVIRONMENT) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Dummy config for local testing
            apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
            authDomain: "forumwidara.firebaseapp.com",
            projectId: "forumwidara",
            storageBucket: "forumwidara.appspot.com",
            appId: "1:216899999999:web:59255f600fc3b3b44eb7e5",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END GLOBAL VARIABLES ---

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingOverlay = document.getElementById('loading-overlay');
        const appContent = document.getElementById('app-content');
        const schoolIdDisplay = document.getElementById('school-id-display'); 

        // Elemen Sidebar
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        
        // Fungsi untuk men-toggle sidebar
        function toggleSidebar() {
            const isHidden = sidebar.classList.contains('-translate-x-full');

            if (isHidden) {
                // Tampilkan Sidebar (Hanya di mobile, di desktop dia relative)
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('flex');
                sidebarBackdrop.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // cegah scroll body
            } else {
                // Sembunyikan Sidebar
                sidebar.classList.add('-translate-x-full');
                sidebarBackdrop.classList.add('hidden');
                document.body.style.overflow = ''; // izinkan scroll body
            }
        }
        
        // FIX SIDEBAR: Tambahkan event listener untuk tombol toggle
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
        }
        if (sidebarClose) {
             sidebarClose.addEventListener('click', toggleSidebar);
        }
        if (sidebarBackdrop) {
             sidebarBackdrop.addEventListener('click', toggleSidebar);
        }


        // Inisialisasi Auth
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Initial token sign-in failed:", e));
        }

        // Listener Auth Utama
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const schoolId = user.uid;
                loadAdminData(schoolId);
            } else {
                // Pengguna tidak login atau sesi berakhir, arahkan ke login
                window.location.href = '../login.html'; 
            }
        });

        // Fungsi Pengambilan Data Admin
        async function loadAdminData(schoolId) {
            try {
                // 1. Ambil data sekolah (koleksi master 'sekolah' menggunakan UID)
                const sekolahDocRef = doc(db, 'sekolah', schoolId);
                const docSnap = await getDoc(sekolahDocRef);

                if (!docSnap.exists() || docSnap.data().status_verifikasi !== 'terverifikasi') {
                    await signOut(auth);
                    alert("Akses ditolak: Akun belum terverifikasi atau data sekolah hilang. Mengarahkan kembali ke login.");
                    window.location.href = '../login.html';
                    return;
                }
                
                const adminData = docSnap.data();
                
                // 2. TAMPILKAN UID ADMIN
                schoolIdDisplay.textContent = schoolId;
                
                // 3. Tampilkan data lainnya
                document.getElementById('admin-name').textContent = adminData.nama_kepala || 'Admin Sekolah';
                document.getElementById('school-name-display').textContent = adminData.nama_sekolah;
                document.getElementById('secret-key-display').textContent = adminData.kode_kunci_rahasia;

                // 4. Hitung jumlah guru (menggunakan 'id_sekolah' yang sama dengan schoolId)
                const guruQuery = query(collection(db, "guru"), where("id_sekolah", "==", schoolId));
                const guruSnapshot = await getDocs(guruQuery);
                document.getElementById('total-guru').textContent = guruSnapshot.size;

                // Sembunyikan loading, tampilkan konten
                loadingOverlay.classList.add('hidden');
                appContent.classList.remove('hidden');

            } catch(error) {
                console.error("Gagal memuat data Admin:", error);
                
                let errorMsg = "Gagal memuat data dashboard.";
                
                if (error.code === 'permission-denied') {
                    errorMsg = "Akses Ditolak (Firestore): Akun Anda telah terautentikasi, tetapi terjadi error 'missing or insufficient permissions'. \n\nMohon periksa FIREBASE SECURITY RULES Anda, khususnya izin READ pada koleksi '/guru'.";
                } else {
                    errorMsg += " Error: " + error.message;
                }
                
                alert(errorMsg);
                await signOut(auth);
                window.location.href = '../login.html';
            }
        }
        
        // Fungsi Logout
        const logoutButton = document.getElementById('logout-button');
        logoutButton.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log('Logout berhasil.');
                window.location.href = '../login.html';
            }).catch((error) => {
                console.error('Logout gagal:', error);
            });
        });
        
        // Fungsi Salin Kode (API Key)
        const copyBtnDash = document.getElementById('copy-key-button-dash');
        const copyStatusDash = document.getElementById('copy-status-dash');
        copyBtnDash.addEventListener('click', () => {
            const secretKey = document.getElementById('secret-key-display').textContent;
            
            navigator.clipboard.writeText(secretKey)
                .then(() => {
                    copyStatusDash.textContent = 'Kode berhasil disalin!';
                    setTimeout(() => { copyStatusDash.textContent = '' }, 2000);
                })
                .catch(err => {
                    console.error("Gagal menyalin menggunakan Clipboard API:", err);
                    copyStatusDash.textContent = 'Gagal menyalin. Salin manual!';
                    setTimeout(() => { copyStatusDash.textContent = '' }, 3000);
                });
        });

    </script>
</body>
</html>

