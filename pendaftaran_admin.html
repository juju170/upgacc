<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftarkan Sekolah Anda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex min-h-screen items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-lg space-y-8">
            <div>
                <h2 class="mt-6 text-center text-3xl font-bold tracking-tight text-gray-900">Daftarkan Sekolah Anda</h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Buat akun Admin dan unggah dokumen bukti untuk verifikasi.
                </p>
            </div>
            
            <!-- Area Notifikasi Error Konfigurasi (JANGAN SAMPAI MUNCUL) -->
            <div id="config-error" class="hidden rounded-lg bg-red-100 p-4">
                <p class="text-sm font-medium text-red-800">Error: Konfigurasi Firebase tidak ditemukan. Pastikan variabel lingkungan `__firebase_config` sudah diatur.</p>
            </div>

            <!-- Area Notifikasi Error Utama -->
            <div id="error-notification" class="hidden rounded-lg bg-red-100 p-4">
                <p class="text-sm font-medium text-red-800" id="error-message"></p>
            </div>

            <!-- Form Pendaftaran (Step 1) -->
            <form id="registration-form" class="mt-8 space-y-6 bg-white p-8 rounded-xl shadow-lg" enctype="multipart/form-data">
                <h3 class="text-xl font-semibold text-gray-800">Data Sekolah & Admin</h3>
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="school-name" class="sr-only">Nama Sekolah</label>
                        <input id="school-name" name="school-name" type="text" required class="relative block w-full rounded-t-lg border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Nama Sekolah (Contoh: SMAN 1 Jakarta)">
                    </div>
                    <div>
                        <label for="admin-name" class="sr-only">Nama Admin (Kepala Sekolah)</label>
                        <input id="admin-name" name="admin-name" type="text" required class="relative block w-full border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Nama Lengkap Kepala Sekolah/Admin">
                    </div>
                    <div>
                        <label for="email-address" class="sr-only">Alamat Email</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="relative block w-full border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Alamat Email (Akan menjadi login Admin)">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="new-password" required class="relative block w-full border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Password (Minimal 6 Karakter)">
                    </div>
                    <div>
                        <label for="proof-file" class="sr-only">Bukti Verifikasi</label>
                        <input id="proof-file" name="proof-file" type="file" required accept="image/*" class="relative block w-full rounded-b-lg border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer" title="Unggah bukti sebagai kepala sekolah (Contoh: Foto SK)">
                    </div>
                </div>

                <div>
                    <textarea id="keterangan" name="keterangan" rows="3" class="relative block w-full appearance-none rounded-lg border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm" placeholder="Keterangan tambahan untuk verifikator (Opsional)"></textarea>
                </div>

                <div>
                    <button type="submit" id="submit-button" class="group relative flex w-full justify-center rounded-lg border border-transparent bg-indigo-600 py-3 px-4 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition">
                        Daftar & Unggah Dokumen
                    </button>
                </div>
            </form>

            <!-- Pesan Sukses (Step 2) -->
            <div id="success-message-container" class="hidden mt-8 space-y-6 bg-white p-8 rounded-xl shadow-lg text-center">
                <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="text-2xl font-bold text-gray-900">Pendaftaran Berhasil!</h3>
                <p class="text-gray-600">Akun Admin Anda telah dibuat. Pendaftaran Anda sekarang **menunggu verifikasi** oleh Developer/Sistem.</p>

                <!-- Status Verifikasi Realtime -->
                <div id="status-card" class="mt-4 p-4 rounded-lg border-2 border-yellow-300 bg-yellow-50">
                    <p class="font-semibold text-yellow-700">Status Verifikasi Saat Ini:</p>
                    <p id="verification-status" class="text-xl font-extrabold text-yellow-800 uppercase mt-1">Pending</p>
                </div>

                <!-- Kunci Rahasia (Akan muncul jika statusnya APPROVED) -->
                <div id="key-section" class="hidden mt-6 bg-indigo-100 p-4 rounded-lg border border-indigo-300">
                    <p class="text-sm font-medium text-indigo-700">Kode Kunci Rahasia Guru Anda:</p>
                    <code id="secret-key" class="block bg-indigo-200 p-3 mt-2 rounded text-lg font-mono text-indigo-900 break-all select-all">
                        <!-- Kunci akan dimuat di sini -->
                    </code>
                    <div class="flex items-center justify-center mt-3">
                        <button id="copy-key-button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                            Salin Kode
                        </button>
                        <span id="copy-status" class="ml-3 text-sm text-green-600"></span>
                    </div>
                    <p class="text-xs text-indigo-600 mt-2">Berikan kode ini kepada Guru Anda untuk mendaftar.</p>
                </div>

                <button onclick="window.location.reload()" class="mt-6 text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                    Kembali ke Halaman Login/Daftar
                </button>
            </div>

        </div>
    </div>

    <!-- Firebase dan Logic Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Asumsi ada Cloudinary atau layanan serupa untuk upload file.
        // Karena tidak ada API Cloudinary, kita akan menggunakan placeholder fungsi.
        // Anda perlu mengganti ini dengan fungsi upload yang sebenarnya.
        
        setLogLevel('Debug');

        // Variabel Global dari Lingkungan Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig) {
            document.getElementById('config-error').classList.remove('hidden');
            return;
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State global
        let currentUserId = null;
        let unsubscribeSnapshot = null;
        let adminDocId = null;

        // Fungsi Placeholder Upload (GANTI INI DENGAN LOGIC ASLI ANDA)
        async function uploadFilePlaceholder(file) {
            // Karena tidak ada API upload file yang nyata, kita akan meniru URL.
            // Di lingkungan nyata, Anda akan menggunakan Firebase Storage atau Cloudinary di sini.
            console.log("Simulasi upload file:", file.name);
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simulasi delay upload
            const fileType = file.type.includes('image') ? 'image' : 'document';
            return `https://placehold.co/600x400/374151/FFFFFF?text=Bukti+Admin+(${fileType})`;
        }
        
        // Event Listener Form Pendaftaran
        const registrationForm = document.getElementById('registration-form');
        const errorNotification = document.getElementById('error-notification');
        const errorMessage = document.getElementById('error-message');
        const submitButton = document.getElementById('submit-button');

        // Fungsi inisialisasi otentikasi
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
            } catch (error) {
                console.error("Auth Initialization Error:", error);
            }
        }
        
        initializeAuth();
        
        // Listener Status Otentikasi
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                currentUserId = null;
                // Tidak perlu sign in anonim karena pendaftaran akan membuat user baru
            }
        });

        // ----------------------------------------------------------------------
        // FUNGSI REALTIME LISTENER UNTUK STATUS VERIFIKASI
        // ----------------------------------------------------------------------
        function startStatusListener(uid) {
            // Admin disimpan di: /artifacts/{appId}/public/data/sekolah/{docId}
            const adminCollectionPath = `/artifacts/${appId}/public/data/sekolah`;
            
            // Cari dokumen admin berdasarkan UID (user baru, jadi hanya ada 1 dokumen)
            const q = query(collection(db, adminCollectionPath), where("uid", "==", uid));

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    console.error("Dokumen admin tidak ditemukan setelah pendaftaran.");
                    return;
                }
                
                const docSnap = snapshot.docs[0];
                const data = docSnap.data();
                adminDocId = docSnap.id; // Simpan Doc ID
                
                const statusText = document.getElementById('verification-status');
                const keySection = document.getElementById('key-section');
                const secretKeyElement = document.getElementById('secret-key');
                const statusCard = document.getElementById('status-card');

                statusText.textContent = data.status_verifikasi.toUpperCase();
                
                // Atur warna card berdasarkan status
                statusCard.className = 'mt-4 p-4 rounded-lg border-2 ' + 
                    (data.status_verifikasi === 'approved' ? 'border-green-300 bg-green-50' : 
                     data.status_verifikasi === 'rejected' ? 'border-red-300 bg-red-50' : 
                     'border-yellow-300 bg-yellow-50');
                statusText.className = 'text-xl font-extrabold uppercase mt-1 ' + 
                    (data.status_verifikasi === 'approved' ? 'text-green-800' : 
                     data.status_verifikasi === 'rejected' ? 'text-red-800' : 
                     'text-yellow-800');

                if (data.status_verifikasi === 'approved') {
                    // Tampilkan kunci rahasia
                    if (data.kunci_rahasia) {
                        secretKeyElement.textContent = data.kunci_rahasia;
                        keySection.classList.remove('hidden');
                        statusText.textContent = "DISETUJUI";
                    } else {
                        // Ini seharusnya tidak terjadi jika developer melakukan approval dengan benar
                        secretKeyElement.textContent = 'ERROR: Kunci tidak ditemukan.';
                        keySection.classList.remove('hidden');
                    }
                } else {
                    keySection.classList.add('hidden');
                }
                
                if (data.status_verifikasi === 'rejected') {
                    // Beri pesan penolakan
                    alert("Pendaftaran Anda telah ditolak. Silakan mendaftar ulang atau hubungi Developer.");
                    // Opsional: Log out dan refresh
                    // signOut(auth);
                    // window.location.reload();
                }

            }, (error) => {
                console.error("Error listening to admin status:", error);
            });
        }
        
        // ----------------------------------------------------------------------
        // FORM SUBMISSION LOGIC
        // ----------------------------------------------------------------------
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorNotification.classList.add('hidden');
            errorMessage.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'Memproses...';

            const schoolName = document.getElementById('school-name').value;
            const adminName = document.getElementById('admin-name').value;
            const email = document.getElementById('email-address').value;
            const password = document.getElementById('password').value;
            const proofFile = document.getElementById('proof-file').files[0];
            const keterangan = document.getElementById('keterangan').value;

            try {
                // 1. Buat pengguna di Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const adminUid = user.uid;

                // 2. Unggah file bukti verifikasi (placeholder)
                submitButton.textContent = 'Mengunggah Bukti...';
                const urlBukti = await uploadFilePlaceholder(proofFile);

                // 3. Simpan data pendaftaran admin ke Firestore
                // Path: /artifacts/{appId}/public/data/sekolah/{docId}
                const adminCollectionRef = collection(db, `/artifacts/${appId}/public/data/sekolah`);

                // Menggunakan addDoc, yang akan membuat docId secara otomatis
                const newDocRef = await addDoc(adminCollectionRef, {
                    uid: adminUid,
                    nama_sekolah: schoolName,
                    nama_admin: adminName,
                    email: email,
                    url_bukti_verifikasi: urlBukti,
                    keterangan: keterangan,
                    status_verifikasi: 'pending', // Status awal
                    kunci_rahasia: null, // Kunci akan ditambahkan setelah disetujui developer
                    createdAt: new Date()
                });
                
                // Log: ID dokumen admin yang baru dibuat.
                console.log("Dokumen Admin dibuat dengan ID:", newDocRef.id);


                // 4. Sukses: Sembunyikan form dan tampilkan pesan sukses
                registrationForm.classList.add('hidden');
                document.getElementById('success-message-container').classList.remove('hidden');

                // 5. Mulai mendengarkan perubahan status verifikasi
                startStatusListener(adminUid);


            } catch (error) {
                console.error("Error pendaftaran Admin:", error);
                
                let message = "Terjadi kesalahan yang tidak diketahui.";
                if (error.code === 'auth/email-already-in-use') {
                    message = 'Email sudah digunakan. Silakan gunakan email lain.';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password terlalu lemah (minimal 6 karakter).';
                } else if (error.message && error.message.includes("Cloudinary")) {
                    message = error.message;
                } else if (error.code === 'permission-denied') {
                    message = 'Gagal menyimpan data ke Firestore. Silakan cek **Firestore Security Rules** Anda!';
                }
                
                errorMessage.textContent = message;
                errorNotification.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Daftar & Unggah Dokumen';
            }
        });

        // Event Listener untuk Salin Kode Rahasia
        const copyBtn = document.getElementById('copy-key-button');
        const copyStatus = document.getElementById('copy-status');
        copyBtn.addEventListener('click', () => {
            // Menggunakan execCommand untuk kompatibilitas yang lebih baik di iframe
            const el = document.createElement('textarea');
            el.value = document.getElementById('secret-key').textContent;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            copyStatus.textContent = 'Kode berhasil disalin!';
            setTimeout(() => { copyStatus.textContent = '' }, 2000);
        });
    </script>
</body>
</html>

