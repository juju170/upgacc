<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pendaftaran Kepala Sekolah — UPGACC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;padding:20px;background:#f4f6fb;color:#111}
    form{max-width:860px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    label{display:block;margin-top:10px;font-weight:600}
    input, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .copy-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    pre{background:#f3f4f6;padding:10px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-2">Pendaftaran Kepala Sekolah</h1>
    <p class="text-gray-500 text-sm mb-4">Isi data, unggah SK + bukti pendirian. Setelah berhasil, akan muncul <strong class="text-blue-600">Kode Sekolah (UUID)</strong> yang dapat disalin.</p>
  
    <form id="regForm">
      <label class="block mb-3">Nama Sekolah
        <input id="nama_sekolah" required placeholder="Contoh: SMP Negeri 1 Contoh" class="rounded-lg">
      </label>

      <label class="block mb-3">Alamat Sekolah
        <textarea id="alamat" rows="2" required placeholder="Alamat lengkap..." class="rounded-lg"></textarea>
      </label>

      <div class="row">
        <label class="block mb-3">Nama Kepala Sekolah
          <input id="nama_kepala" required placeholder="Nama kepala sekolah" class="rounded-lg">
        </label>
        <label class="block mb-3">Email (akun admin)
          <input id="email" type="email" required placeholder="admin@example.com" class="rounded-lg">
        </label>
      </div>

      <div class="row">
        <label class="block mb-3">No. HP (optional)
          <input id="no_hp" placeholder="+62..." class="rounded-lg">
        </label>
        <label class="block mb-3">Password akun (minimal 6 karakter)
          <input id="password" type="text" required placeholder="isi password untuk akun admin" class="rounded-lg">
        </label>
      </div>

      <label class="block mb-3">Unggah Foto / Scan SK Pengangkatan Kepala Sekolah (image/pdf)
        <div class="flex items-center gap-3 mt-1">
          <input id="file_sk" type="file" accept="image/*,application/pdf" required class="w-2/3">
          <div class="text-xs text-gray-500">Max ~5MB disarankan</div>
        </div>
      </label>

      <label class="block mb-3">Unggah Bukti Pendirian Sekolah / Foto Bangunan (image)
        <div class="flex items-center gap-3 mt-1">
          <input id="file_bukti" type="file" accept="image/*" required class="w-2/3">
          <div class="text-xs text-gray-500">Max ~5MB disarankan</div>
        </div>
      </label>

      <div class="flex gap-3 mt-4">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold shadow hover:bg-blue-700 transition" id="submitBtn">Daftar & Buat Kode Sekolah</button>
        <button type="button" id="signInExisting" class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200 transition">Saya sudah punya akun — Login</button>
      </div>

      <div id="msg" class="mt-4"></div>
    </form>

    <div id="result" class="mt-8 hidden"></div>
  </div>


  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
      <h3 class="text-xl font-bold mb-4">Login Admin Sekolah</h3>
      <div id="loginMsg" class="text-sm text-gray-600 mb-3"></div>
      <label class="block mb-3">Email
        <input id="loginEmail" type="email" placeholder="email@example.com" class="rounded-lg">
      </label>
      <label class="block mb-4">Password
        <input id="loginPassword" type="password" placeholder="******" class="rounded-lg">
      </label>
      <div class="flex justify-end gap-2">
        <button id="closeLogin" type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Batal</button>
        <button id="doLogin" type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Login</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
// import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// --- GLOBAL VARIABLES (MANDATORY FOR CANVAS ENVIRONMENT) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
  apiKey: "AIzaSyA6zXOerKvdPJTmBp5Y6R2yFsy98xLDsKc",
  authDomain: "forumwidara.firebaseapp.com",
  projectId: "forumwidara",
  storageBucket: "forumwidara.appspot.com",
  messagingSenderId: "216895655168",
  appId: "1:216899999999:web:59255f600fc3b3b44eb7e5", // Gunakan ID dummy yang valid
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
setLogLevel('debug'); // Wajib untuk debugging firestore
// --- END GLOBAL VARIABLES ---

const CLOUDINARY_CONFIG = { cloud_name: "dgqg7w1p3", upload_preset: "sekolah_unsigned" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Sign in as anonymous user or with custom token on load
async function initializeAuth() {
  if (initialAuthToken) {
    try {
      await signInWithCustomToken(auth, initialAuthToken);
      console.log('Signed in with initial token.');
    } catch(e) {
      console.error('Initial token sign-in failed:', e);
      // Fallback: Continue without auth if custom token fails
    }
  } else {
    // Attempt anonymous sign-in, but handle if restricted
    try {
        // Hapus signInAnonymously karena sering dibatasi di beberapa project, 
        // dan untuk pendaftaran admin, kita hanya perlu unauthenticated state
        // await signInAnonymously(auth); 
        console.log('Skipping anonymous sign-in for admin registration form.');
    } catch(e) {
        // Ini adalah error yang Anda lihat. Hapus signInAnonymously di atas untuk mengatasi ini.
        console.error('Anonymous sign-in failed: FirebaseError: Firebase: Error (auth/admin-restricted-operation). (Ignored)', e);
    }
  }
}

initializeAuth();


const form = document.getElementById('regForm');
const msg = document.getElementById('msg');
const result = document.getElementById('result');
const signInExisting = document.getElementById('signInExisting');
const submitBtn = document.getElementById('submitBtn');
const loginModal = document.getElementById('loginModal');
const doLogin = document.getElementById('doLogin');
const closeLogin = document.getElementById('closeLogin');
const loginMsg = document.getElementById('loginMsg');

function showMsg(text, type='info'){
  if(!text){ msg.innerHTML=''; return; }
  let cls = 'p-3 rounded-lg mt-3 text-sm';
  if(type==='ok') cls += ' bg-green-100 text-green-800';
  else if(type==='err') cls += ' bg-red-100 text-red-800';
  else cls += ' bg-blue-100 text-blue-700';
  msg.innerHTML = `<div class="${cls}">${escapeHtml(text)}</div>`;
}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));}

function uuidv4(){
  try{
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4).toString(16));
  }catch(e){
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){const r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});
  }
}

// --- Login Modal Logic ---
signInExisting.addEventListener('click', ()=>{
  loginModal.classList.remove('hidden');
  loginModal.style.display = 'flex';
  loginMsg.textContent = 'Masukkan kredensial akun admin yang sudah terdaftar.';
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
});
closeLogin.addEventListener('click', ()=> {
  loginModal.classList.add('hidden');
  loginModal.style.display = 'none';
});

doLogin.addEventListener('click', async ()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!email || !password) { loginMsg.textContent = 'Email dan password wajib diisi.'; return; }

  loginMsg.textContent = 'Mencoba login...';
  doLogin.disabled = true;
  try{
    await signInWithEmailAndPassword(auth, email, password);
    loginMsg.textContent = 'Berhasil login.';
    loginModal.classList.add('hidden');
    loginModal.style.display = 'none';
    showMsg('Berhasil login. Anda dapat melanjutkan ke halaman admin atau dashboard.','ok');
  }catch(err){
    console.error(err);
    loginMsg.innerHTML = `<span class="text-red-700">Gagal login: ${err.message || err.code}</span>`;
  } finally {
    doLogin.disabled = false;
  }
});
// --- End Login Modal Logic ---


form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  submitBtn.disabled = true;
  showMsg('Memproses pendaftaran...');
  result.classList.add('hidden');
  
  const nama_sekolah = document.getElementById('nama_sekolah').value.trim();
  const alamat = document.getElementById('alamat').value.trim();
  const nama_kepala = document.getElementById('nama_kepala').value.trim();
  const email = document.getElementById('email').value.trim();
  const no_hp = document.getElementById('no_hp').value.trim();
  const password = document.getElementById('password').value;
  const fileSk = document.getElementById('file_sk').files[0];
  const fileBukti = document.getElementById('file_bukti').files[0];

  if(!nama_sekolah||!nama_kepala||!email||!password||!fileSk||!fileBukti){ 
    showMsg('Mohon lengkapi semua isian dan unggah kedua file.','err');
    submitBtn.disabled = false;
    return;
  }
  if(password.length < 6){ 
    showMsg('Password minimal 6 karakter.','err');
    submitBtn.disabled = false;
    return;
  }

  let user = null;
  let kode_sekolah = null;
  
  try{
    // 1. BUAT AKUN ADMIN
    showMsg('Membuat akun Firebase...');
    if(auth.currentUser) await auth.signOut(); // Pastikan tidak ada yang login sebelum membuat yang baru
    
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    user = userCredential.user;
    const uid = user.uid;
    kode_sekolah = uuidv4();

    // 2. UNGGAH FILE KE CLOUDINARY
    showMsg('Mengunggah SK dan bukti pendirian ke Cloudinary...');
    // Gunakan UID baru sebagai bagian dari path folder Cloudinary
    const uploadPath = `sekolah/${uid}`; 
    const urlSk = await uploadToCloudinary(fileSk, `${uploadPath}/sk_${Date.now()}`);
    const urlBukti = await uploadToCloudinary(fileBukti, `${uploadPath}/bukti_${Date.now()}`);

    // 3. SIAPKAN DATA
    const data = {
      uid_admin: uid,
      nama_sekolah,
      alamat,
      nama_kepala,
      email_admin: email,
      no_hp: no_hp || null,
      url_sk_pengangkatan: urlSk, 
      url_bukti_pendirian: urlBukti, 
      kode_sekolah,
      status_verifikasi: 'pending',
      created_at: serverTimestamp(),
      updated_at: serverTimestamp()
    };

    // 4. SIMPAN KE FIREBASE (KOLEKSI MASTER)
    showMsg('Menyimpan data master ke koleksi /sekolah/ (memerlukan Auth UID)...');
    await setDoc(doc(db, 'sekolah', uid), data);

    // 5. SIMPAN KE FIREBASE (KOLEKSI VERIFIKASI)
    showMsg('Menyimpan salinan ke koleksi verifikasi /artifacts/.../sekolah/...');
    const verifRef = collection(db, 'artifacts', appId, 'public', 'data', 'sekolah');
    await addDoc(verifRef, Object.assign({}, data, { source: 'admin_signup', original_uid: uid, verif_status: 'pending' }));

    // 6. TAMPILKAN HASIL SUKSES
    showMsg('Pendaftaran berhasil — simpan kode sekolah dan bagikan ke guru.','ok');
    
    result.classList.remove('hidden');
    result.innerHTML = `
      <div class="bg-green-100 border border-green-400 text-green-700 p-4 rounded-lg">
        Akun admin berhasil dibuat dan dokumen pendaftaran telah dikirim untuk diverifikasi.
      </div>
      <p class="mt-4 text-lg font-semibold">Kode Sekolah (UUID)</p>
      <div class="copy-row">
        <input id="kodeField" type="text" value="${escapeHtml(kode_sekolah)}" readonly class="p-3 border border-blue-400 bg-blue-50 rounded-lg w-full max-w-lg font-mono">
        <button id="copyBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Salin</button>
      </div>
      <p class="text-sm text-gray-500 mt-2">Bagikan kode ini kepada guru agar mereka dapat mendaftar ke sekolah yang sama.</p>
      <h4 class="mt-4 text-lg font-semibold">Preview Data Pendaftaran</h4>
      <pre class="text-xs">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
    `;

    document.getElementById('copyBtn').addEventListener('click', ()=>{
      const kodeField = document.getElementById('kodeField');
      kodeField.select();
      document.execCommand('copy');
      document.getElementById('copyBtn').textContent = 'Tersalin!';
      setTimeout(()=>document.getElementById('copyBtn').textContent = 'Salin', 2000);
    });

  }catch(err){
    console.error('Register error:', err);
    let errorMessage = 'Terjadi kesalahan tidak terduga: ' + (err.message || err.code || String(err));
    
    if(err.code === 'auth/email-already-in-use') {
      errorMessage = 'Email sudah terdaftar. Silakan gunakan tombol "Saya sudah punya akun — Login" di bawah.';
    } else if (err.code && err.code.startsWith('firestore')) {
        errorMessage = 'Gagal menyimpan data pendaftaran (Firestore). Kemungkinan GAGAL SECURITY RULES (Error: ' + err.code + ')';
    } else if (err.message && err.message.includes('Cloudinary upload failed')) {
        errorMessage = 'Gagal mengunggah file. Pastikan nama Cloudinary Anda benar dan preset "sekolah_unsigned" sudah diizinkan untuk unsigned upload.';
    }
    
    showMsg(errorMessage,'err');
    
  } finally {
    submitBtn.disabled = false;
  }
});

async function uploadToCloudinary(file, publicId){
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloud_name}/upload`;
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', CLOUDINARY_CONFIG.upload_preset);
  fd.append('folder', publicId.split('/').slice(0,1).join('/') || 'sekolah');
  
  // SOLUSI: Hapus `transformation` dari FormData.
  // Jika Anda *tetap* ingin transformasi, kirim sebagai string kueri:
  // fd.append('transformation', 'q_auto,f_auto'); 
  // Namun, untuk menghindari error, kita hapus saja.

  const res = await fetch(url, { method:'POST', body: fd });
  if(!res.ok){
    const txt = await res.text();
    // Beri pesan error yang lebih jelas
    throw new Error(`Cloudinary upload failed (${res.status}): ${txt.substring(0, 100)}...`);
  }
  const data = await res.json();
  return data.secure_url;
}
</script>
</body>
</html>

