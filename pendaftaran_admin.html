<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pendaftaran Kepala Sekolah — UPGACC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;padding:20px;background:#f4f6fb;color:#111}
    form{max-width:860px;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,0.06)}
    label{display:block;margin-top:10px;font-weight:600}
    input, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .copy-row{display:flex;gap:8px;align-items:center;margin-top:8px}
    pre{background:#f3f4f6;padding:10px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-center text-indigo-700">Pendaftaran Akun Kepala Sekolah</h1>
    <p class="text-center mb-6 text-gray-600">Lengkapi data untuk membuat akun Admin dan kode unik sekolah (UUID).</p>

    <!-- Notifikasi Sukses/Error -->
    <div id="message-area" class="mb-4"></div>

    <form id="registrationForm" class="space-y-4">
      <!-- Informasi Akun -->
      <h2 class="text-xl font-semibold border-b pb-2 text-indigo-600">1. Data Akun & Pribadi</h2>
      
      <div class="row">
        <div>
          <label for="nama_kepala">Nama Kepala Sekolah</label>
          <input type="text" id="nama_kepala" name="nama_kepala" required placeholder="Contoh: Budi Santoso" />
        </div>
        <div>
          <label for="email">Email Admin</label>
          <input type="email" id="email" name="email" required placeholder="admin@sekolahanda.sch.id" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="password">Kata Sandi (Min. 6 Karakter)</label>
          <input type="password" id="password" name="password" required />
        </div>
        <div>
          <label for="nohp">Nomor HP</label>
          <input type="tel" id="nohp" name="nohp" required placeholder="Contoh: 0812xxxxxx" />
        </div>
      </div>

      <!-- Informasi Sekolah -->
      <h2 class="text-xl font-semibold border-b pb-2 pt-6 text-indigo-600">2. Data Sekolah</h2>
      
      <div>
        <label for="nama_sekolah">Nama Sekolah</label>
        <input type="text" id="nama_sekolah" name="nama_sekolah" required placeholder="Contoh: SMA Negeri 1 Jakarta" />
      </div>

      <div>
        <label for="alamat">Alamat Lengkap Sekolah</label>
        <textarea id="alamat" name="alamat" rows="3" required placeholder="Masukkan alamat lengkap"></textarea>
      </div>

      <!-- Logo Sekolah -->
      <h2 class="text-xl font-semibold border-b pb-2 pt-6 text-indigo-600">3. Logo Sekolah (Wajib PNG/JPG)</h2>
      <input type="file" id="logo_sekolah" name="logo_sekolah" accept="image/png, image/jpeg" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
      <p class="text-xs text-gray-500 mt-1">Logo akan digunakan sebagai identitas sistem.</p>

      <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition duration-150 mt-6">
        Daftar & Buat Akun Admin
      </button>
      
      <p class="text-center mt-4 text-sm text-gray-600">
        <a href="login.html" class="font-medium text-indigo-600 hover:text-indigo-500">
            Sudah punya akun — Login
        </a>
    </p>
    </form>

    <!-- Area untuk menampilkan UUID setelah pendaftaran berhasil -->
    <div id="uuid-display" class="hidden mt-8 p-6 bg-green-50 border-l-4 border-green-400 text-green-800 rounded-lg">
      <h3 class="text-lg font-bold">Pendaftaran Berhasil!</h3>
      <p class="mt-2">Simpan **Kode Kunci Rahasia** ini. Kode ini wajib diberikan kepada semua Guru yang akan mendaftar ke sekolah Anda.</p>
      <div class="copy-row mt-4">
        <pre id="display-uuid" class="flex-grow"></pre>
        <button id="copy-uuid-btn" class="bg-green-600 text-white p-2 rounded-lg text-sm hover:bg-green-700 transition">Salin</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Global variables for Firebase config (MANDATORY USE)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    
    // Konfigurasi Cloudinary Anda (GANTI INI DENGAN DATA ANDA)
    // NOTE: Ganti cloud_name dan pastikan preset 'sekolah_unsigned' ada
    const CLOUDINARY_CONFIG = {
        cloud_name: '{{CLOUDINARY_CLOUD_NAME_ANDA}}', // GANTI DENGAN NAMA CLOUD ANDA
        upload_preset: 'sekolah_unsigned' 
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setLogLevel('debug'); // Aktifkan logging

    const registrationForm = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const messageArea = document.getElementById('message-area');
    const uuidDisplay = document.getElementById('uuid-display');
    const displayUuid = document.getElementById('display-uuid');
    const copyUuidBtn = document.getElementById('copy-uuid-btn');

    // Utility: UUID Generator (Kode Kunci Rahasia Sekolah)
    function generateUUID() {
      // Menggunakan crypto.randomUUID() jika tersedia, fallback ke implementasi dasar
      if (typeof crypto.randomUUID === 'function') {
        return crypto.randomUUID();
      }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Utility: Notifikasi
    function showMsg(message, type = 'info') {
        const color = type === 'err' ? 'bg-red-100 border-red-400 text-red-800' : 'bg-green-100 border-green-400 text-green-800';
        messageArea.innerHTML = `<div class="p-4 border-l-4 ${color} rounded-lg">${message}</div>`;
    }

    // Utility: Cloudinary Upload
    async function uploadToCloudinary(file, publicId){
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloud_name}/upload`;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', CLOUDINARY_CONFIG.upload_preset);
      fd.append('folder', 'sekolah_logos'); // Folder khusus untuk logo
      fd.append('public_id', publicId); // Gunakan UUID sebagai public_id

      const res = await fetch(url, { method:'POST', body: fd });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(`Cloudinary upload failed: ${txt}`);
      }
      return (await res.json()).secure_url;
    }

    // Tombol salin UUID
    copyUuidBtn.addEventListener('click', () => {
        document.execCommand('copy');
        copyUuidBtn.textContent = 'Tersalin!';
        setTimeout(() => { copyUuidBtn.textContent = 'Salin'; }, 2000);
    });
    
    displayUuid.addEventListener('copy', (e) => {
        e.clipboardData.setData('text/plain', displayUuid.textContent.trim());
        e.preventDefault();
    });

    // --- LOGIC UTAMA PENDAFTARAN ADMIN ---
    registrationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sedang Mendaftar...';
      messageArea.innerHTML = '';
      uuidDisplay.classList.add('hidden');

      const email = registrationForm.email.value;
      const password = registrationForm.password.value;
      const namaKepala = registrationForm.nama_kepala.value;
      const namaSekolah = registrationForm.nama_sekolah.value;
      const alamat = registrationForm.alamat.value;
      const nohp = registrationForm.nohp.value;
      const logoFile = registrationForm.logo_sekolah.files[0];
      
      const newUUID = generateUUID();
      let logoUrl = '';
      
      try {
        // 1. Upload Logo Sekolah ke Cloudinary
        showMsg("Mengunggah Logo Sekolah, harap tunggu...");
        logoUrl = await uploadToCloudinary(logoFile, `logo_${newUUID}`);
        showMsg("Logo berhasil diunggah. Melanjutkan pendaftaran...");
        
        // 2. Buat Akun di Firebase Authentication
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // 3. Simpan Data Sekolah di Koleksi Publik
        // Lokasi: /artifacts/{appId}/public/data/schools/{newUUID}
        const schoolPublicRef = doc(db, `artifacts/${appId}/public/data/schools`, newUUID);
        await setDoc(schoolPublicRef, {
            schoolId: newUUID,
            nama_sekolah: namaSekolah,
            alamat: alamat,
            logo_url: logoUrl,
            adminUid: user.uid,
            dibuatPada: new Date().toISOString()
        });

        // 4. Simpan Data Profil Admin (KRITIS UNTUK LOGIN)
        // Lokasi: /artifacts/{appId}/users/{user.uid}/profile/data
        const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'data');
        await setDoc(userProfileRef, {
            // FIELD KRITIS BARU UNTUK LOGIN MULTI-ROLE
            peran: 'Admin Sekolah', // <--- KRITIS: DITAMBAHKAN DI SINI
            status: 'Aktif', // ADMIN selalu aktif
            schoolId: newUUID, // Simpan UUID sekolah yang dia kelola
            
            // Data Pribadi Admin
            nama_kepala: namaKepala, 
            nohp: nohp,
            email: email
        });

        // 5. Update Display Name di Auth (Opsional)
        await updateProfile(user, { displayName: namaKepala });
        
        // 6. Beri Tahu Sukses dan Tampilkan UUID
        displayUuid.textContent = newUUID;
        uuidDisplay.classList.remove('hidden');
        registrationForm.reset();
        showMsg("Pendaftaran Kepala Sekolah berhasil! Akun Admin siap digunakan. Jangan lupa salin Kode Kunci Rahasia di bawah.", 'success');
        await signOut(auth); // Log out setelah pendaftaran agar bisa langsung login

      } catch (err) {
        console.error(err);
        let errorMessage = 'Gagal mendaftar. Silakan cek koneksi dan data.';

        if (err.code === 'auth/email-already-in-use') {
            errorMessage = 'Email sudah terdaftar. Gunakan tombol "Login" di bawah.';
        } else if (err.code === 'auth/weak-password') {
             errorMessage = 'Password terlalu lemah. Harus minimal 6 karakter.';
        } else if (err.code === 'permission-denied') {
            errorMessage = 'Gagal menyimpan data ke Firestore. Periksa **Firestore Security Rules** Anda!';
        } else if (err.message && err.message.includes('Cloudinary upload failed')) {
            errorMessage = 'Gagal mengunggah logo. Pastikan konfigurasi Cloudinary di kode ini sudah benar.';
        } else if (err.message) {
            errorMessage = 'Error: ' + err.message;
        }
        
        showMsg(errorMessage,'err');
        
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Daftar & Buat Akun Admin';
      }
    });
  </script>
</body>
</html>

